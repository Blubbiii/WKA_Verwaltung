# =============================================================================
# WindparkManager - Traefik Dynamic Configuration
# Middlewares, Services, Routers
# =============================================================================

# =============================================================================
# HTTP Configuration
# =============================================================================
http:
  # ---------------------------------------------------------------------------
  # Middlewares
  # ---------------------------------------------------------------------------
  middlewares:
    # -------------------------------------------------------------------------
    # Security Headers (OWASP Best Practices)
    # -------------------------------------------------------------------------
    security-headers:
      headers:
        # HTTPS erzwingen
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true

        # Clickjacking Schutz
        frameDeny: true

        # XSS Schutz
        browserXssFilter: true
        contentTypeNosniff: true

        # Referrer Policy
        referrerPolicy: "strict-origin-when-cross-origin"

        # Permissions Policy (ehem. Feature-Policy)
        permissionsPolicy: >-
          accelerometer=(),
          ambient-light-sensor=(),
          autoplay=(),
          battery=(),
          camera=(),
          cross-origin-isolated=(),
          display-capture=(),
          document-domain=(),
          encrypted-media=(),
          execution-while-not-rendered=(),
          execution-while-out-of-viewport=(),
          fullscreen=(self),
          geolocation=(),
          gyroscope=(),
          keyboard-map=(),
          magnetometer=(),
          microphone=(),
          midi=(),
          navigation-override=(),
          payment=(),
          picture-in-picture=(),
          publickey-credentials-get=(),
          screen-wake-lock=(),
          sync-xhr=(),
          usb=(),
          web-share=(),
          xr-spatial-tracking=()

        # Content Security Policy
        # Anpassen je nach Bedarf (z.B. fuer externe Scripts/Fonts)
        contentSecurityPolicy: >-
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval';
          style-src 'self' 'unsafe-inline';
          img-src 'self' data: blob: https:;
          font-src 'self' data:;
          connect-src 'self' https:;
          frame-ancestors 'none';
          form-action 'self';
          base-uri 'self';

        # Custom Headers
        customResponseHeaders:
          X-Robots-Tag: "noindex, nofollow, noarchive"
          X-Content-Type-Options: "nosniff"
          X-Frame-Options: "DENY"
          X-XSS-Protection: "1; mode=block"

    # -------------------------------------------------------------------------
    # Kompression
    # -------------------------------------------------------------------------
    compress:
      compress:
        excludedContentTypes:
          - text/event-stream

    # -------------------------------------------------------------------------
    # Rate Limiting
    # -------------------------------------------------------------------------
    rate-limit:
      rateLimit:
        average: 100
        burst: 200
        period: 1s
        sourceCriterion:
          ipStrategy:
            depth: 1

    # -------------------------------------------------------------------------
    # Rate Limiting fuer API Endpoints (strenger)
    # -------------------------------------------------------------------------
    rate-limit-api:
      rateLimit:
        average: 50
        burst: 100
        period: 1s
        sourceCriterion:
          ipStrategy:
            depth: 1

    # -------------------------------------------------------------------------
    # IP Whitelist (fuer Admin-Bereiche)
    # -------------------------------------------------------------------------
    # ip-whitelist:
    #   ipWhiteList:
    #     sourceRange:
    #       - "127.0.0.1/32"
    #       - "10.0.0.0/8"
    #       - "172.16.0.0/12"
    #       - "192.168.0.0/16"

    # -------------------------------------------------------------------------
    # Basic Auth (fuer Traefik Dashboard)
    # -------------------------------------------------------------------------
    # Generieren mit: htpasswd -nb admin password | sed -e s/\\$/\\$\\$/g
    auth:
      basicAuth:
        users:
          # Default: admin:admin (BITTE AENDERN!)
          # Generieren: echo $(htpasswd -nb admin yourpassword) | sed -e s/\\$/\\$\\$/g
          - "admin:$$apr1$$H6uskkkW$$IgXLP6ewTrSuBkTrqE8wj/"

    # -------------------------------------------------------------------------
    # Retry Middleware
    # -------------------------------------------------------------------------
    retry:
      retry:
        attempts: 3
        initialInterval: 100ms

    # -------------------------------------------------------------------------
    # Circuit Breaker
    # -------------------------------------------------------------------------
    circuit-breaker:
      circuitBreaker:
        expression: "NetworkErrorRatio() > 0.5 || ResponseCodeRatio(500, 600, 0, 600) > 0.5"

    # -------------------------------------------------------------------------
    # Request Size Limit (10MB)
    # -------------------------------------------------------------------------
    body-limit:
      buffering:
        maxRequestBodyBytes: 10485760

  # ---------------------------------------------------------------------------
  # Routers (zusaetzlich zu Docker Labels)
  # ---------------------------------------------------------------------------
  routers: {}

  # ---------------------------------------------------------------------------
  # Services (zusaetzlich zu Docker Labels)
  # ---------------------------------------------------------------------------
  services: {}

# =============================================================================
# TCP Configuration (falls benoetigt)
# =============================================================================
# tcp:
#   routers: {}
#   services: {}

# =============================================================================
# TLS Configuration
# =============================================================================
tls:
  options:
    default:
      minVersion: VersionTLS12
      cipherSuites:
        - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305
        - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
      curvePreferences:
        - CurveP521
        - CurveP384
      sniStrict: true

    # Strengere TLS-Einstellungen (nur TLS 1.3)
    modern:
      minVersion: VersionTLS13
      sniStrict: true
